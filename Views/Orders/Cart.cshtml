@{
    ViewData["Title"] = "Cart";
}
<h2>Cart</h2>

<div id="cart-area"></div>

<div class="mt-3">
    <label>Customer name (optional)</label>
    <input id="customerName" class="form-control" />
</div>

<div class="mt-3">
    <button id="btnCheckout" class="btn btn-primary">Proceed to Checkout</button>
    <a href="/Orders/Menu" class="btn btn-secondary">Continue shopping</a>
</div>

@section Scripts {
<script>
    function getCart(){ return JSON.parse(localStorage.getItem('aibot_cart') || '[]'); }
    function saveCart(c){ localStorage.setItem('aibot_cart', JSON.stringify(c)); }

    function renderCart(){
        const cart = getCart();
        const area = document.getElementById('cart-area');
        if(cart.length==0){ area.innerHTML = '<div class="alert alert-info">Cart is empty.</div>'; return; }

        let html = '<table class="table"><thead><tr><th>Item</th><th>Qty</th><th>Price</th><th>Total</th><th></th></tr></thead><tbody>';
        let total = 0;
        cart.forEach((it, idx) => {
            const line = it.price * it.quantity;
            total += line;
            html += `<tr>
                        <td>${it.name}</td>
                        <td><input class="form-control qty" data-idx="${idx}" value="${it.quantity}" style="width:80px"/></td>
                        <td>₹${it.price.toFixed(2)}</td>
                        <td>₹${line.toFixed(2)}</td>
                        <td><button class="btn btn-sm btn-danger remove" data-idx="${idx}">Remove</button></td>
                     </tr>`;
        });
        html += `</tbody></table><div class="text-end"><h4>Subtotal: ₹${total.toFixed(2)}</h4></div>`;
        area.innerHTML = html;
    }

    document.addEventListener('click', async (e) => {
        if(e.target.matches('.remove')){
            const idx = parseInt(e.target.getAttribute('data-idx'));
            const cart = getCart();
            cart.splice(idx,1);
            saveCart(cart);
            renderCart();
        }
    });

    document.addEventListener('change', (e) => {
        if(e.target.matches('.qty')){
            const idx = parseInt(e.target.getAttribute('data-idx'));
            const val = parseInt(e.target.value) || 1;
            const cart = getCart();
            cart[idx].quantity = val;
            saveCart(cart);
            renderCart();
        }
    });

    document.getElementById('btnCheckout').addEventListener('click', async () => {
        const cart = getCart();
        if(!cart || cart.length==0){ alert('Cart empty'); return; }

        const payload = {
            customerName: document.getElementById('customerName').value || null,
            orderType: 0,
            items: cart.map(c => ({ menuItemId: c.menuItemId, quantity: c.quantity, addons: c.addons || [] }))
        };

        const res = await fetch('/Orders/Checkout', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });

        if(!res.ok){
            const txt = await res.text();
            alert('Checkout failed: ' + txt);
            return;
        }

        const data = await res.json();
        // clear local cart and redirect to payment placeholder or payment provider
        localStorage.removeItem('aibot_cart');
        window.location = data.paymentUrl;
    });

    // initial render
    renderCart();
</script>
}